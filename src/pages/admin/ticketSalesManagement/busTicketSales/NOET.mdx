import React, { useEffect, useState } from "react";
import { Table, message, Button } from "antd";
import type { ColumnsType } from "antd/es/table";
import { BusDriverListPage } from "../../ticketSalesManagement/busTicketSales/busDriverListPage"; 
import { BusCoachListPage } from "../../ticketSalesManagement/busTicketSales/busCoachListPage"; // ✅ Import danh sách xe khách

interface TripTicket {
  tripCarId: number;
  tripName: string;
  departureDate: string;
  departureTime: string;
  departureEndTime: string;
  pickupPoint: string;
  payPoint: string;
  seatNumber: number;
  emptySeatNumber: number;
  priceSeatNumber: number;
  fullName?: string;
  phoneNumber?: string;
}

interface BusTicketSalesListPageProps {
  onAddTicket: () => void;
  onAddDriver: () => void;
  onAddCoach: () => void;
  onShowListDriver: () => void; 
  onShowListCoach: () => void;  // ✅ Thêm prop mở danh sách xe & biển số
}

const BusTicketSalesListPage: React.FC<BusTicketSalesListPageProps> = ({
  onAddTicket,
  onAddDriver,
  onAddCoach,
}) => {
  const [tickets, setTickets] = useState<TripTicket[]>([]);
  const [loading, setLoading] = useState<boolean>(false);
  const [showDriverPage, setShowDriverPage] = useState(false); 
  const [showCoachPage, setShowCoachPage] = useState(false); // ✅ Kiểm soát hiển thị trang xe khách

  useEffect(() => {
    fetchAllTrips();
  }, []);

  const fetchAllTrips = async () => {
    setLoading(true);
    try {
      const token = localStorage.getItem("token");
      if (!token || token.split(".").length !== 3) {
        message.error("Token không hợp lệ hoặc chưa đăng nhập.");
        return;
      }

      const response = await fetch("http://localhost:8080/api/useradmin-all-tripcar", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || "Không thể lấy dữ liệu chuyến xe.");
      }

      setTickets(Array.isArray(data) ? data : []);
      message.success("Đã tải danh sách chuyến xe thành công");
    } catch (error) {
      console.error("Lỗi khi tải danh sách chuyến xe:", error);
      message.error("Không thể tải danh sách chuyến xe");
    } finally {
      setLoading(false);
    }
  };

  const columns: ColumnsType<TripTicket> = [
  { title: "Tên chuyến", dataIndex: "tripName", key: "tripName" },
  { title: "Điểm đón", dataIndex: "pickupPoint", key: "pickupPoint" },
  { title: "Điểm trả", dataIndex: "payPonit", key: "payPonit" }, // ✅ Sửa tên chính xác
  { title: "Ngày khởi hành", dataIndex: "departureDate", key: "departureDate" },
  { title: "Giờ khởi hành", dataIndex: "departureTime", key: "departureTime" },
  { title: "Giờ kết thúc", dataIndex: "departureEndTime", key: "departureEndTime" },
  { title: "Tổng số ghế", dataIndex: "seatNumber", key: "seatNumber" },
  { title: "Ghế trống", dataIndex: "emptySeatNumber", key: "emptySeatNumber" },
  {
    title: "Giá vé (VNĐ)",
    dataIndex: "priceSeatNumber",
    key: "priceSeatNumber",
    render: (price: number) => price?.toLocaleString("vi-VN") || "0",
  },
  { title: "Tên tài xế", dataIndex: "fullName", key: "fullName" },
  { title: "SĐT tài xế", dataIndex: "phoneNumber", key: "phoneNumber" },
];


  return (
    <div className="p-8 bg-white max-w-7xl mx-auto shadow rounded">
      {showDriverPage ? (
        <>
          <Button onClick={() => setShowDriverPage(false)} style={{ marginBottom: 16 }}>
            Quay lại danh sách vé
          </Button>
          <BusDriverListPage />
        </>
      ) : showCoachPage ? (
        <>
          <Button onClick={() => setShowCoachPage(false)} style={{ marginBottom: 16 }}>
            Quay lại danh sách vé
          </Button>
          <BusCoachListPage />
        </>
      ) : (
          <div
    style={{
      padding: "20px",
      backgroundColor: "#fff",
      margin: "auto",
      // borderRadius: "8px",
      boxShadow: "0px 4px 12px rgba(0, 0, 0, 0.1)",
    }}
  >
    <h2
      style={{
        fontSize: "24px",
        fontWeight: "bold",
        marginBottom: "16px",
        textAlign: "center",
      }}
    >
      Danh sách vé xe Bus
    </h2>

    <div
      style={{
        display: "flex",
        flexWrap: "wrap",
        gap: "10px",
        justifyContent: "center",
        marginBottom: "20px",
      }}
    >
      <Button type="primary" onClick={onAddTicket} style={{ backgroundColor: "#28a745", color: "#fff" }}>
        Thêm vé xe mới
      </Button>
      <Button type="primary" onClick={onAddDriver} style={{ backgroundColor: "#007bff", color: "#fff" }}>
        Thêm tài xế mới
      </Button>
      <Button type="primary" onClick={onAddCoach} style={{ backgroundColor: "#ffc107", color: "#fff" }}>
        Thêm loại xe
      </Button>
      <Button type="primary" onClick={() => setShowDriverPage(true)} style={{ backgroundColor: "#dc3545", color: "#fff" }}>
        Xem danh sách tài xế
      </Button>
      <Button type="primary" onClick={() => setShowCoachPage(true)} style={{ backgroundColor: "#5F9EA0", color: "#fff" }}>
        Xem danh sách xe & biển số
      </Button>
    </div>

    <div style={{ overflowX: "auto", borderRadius: "8px" }}>
      <Table
        columns={columns}
        dataSource={tickets}
        rowKey="tripCarId"
        loading={loading}
        bordered
        pagination={{ pageSize: 10 }}
        scroll={{ x: "max-content" }} // ✅ Tự động cuộn ngang khi có nhiều cột
      />
    </div>
  </div>
      )}
    </div>
  );
};

export { BusTicketSalesListPage };
